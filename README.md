# 薪マップ 🪵 - 薪の販売場所共有アプリ

薪の販売場所を地図上で共有できるプログレッシブWebアプリケーション（PWA）です。キャンプや薪ストーブユーザーが薪の販売場所を登録・検索・共有できます。

## 🎯 プロジェクト概要

**薪マップ**は、薪の販売場所を地図上にマーカーで表示し、誰でも簡単に薪を購入できる場所を見つけられるようにするWebアプリケーションです。PWA対応により、スマートフォンのホーム画面に追加してネイティブアプリのように使用できます。

## ✨ 実装済み機能

### 📍 地図表示機能
- **OpenStreetMap**を使用した無料の地図表示
- 薪販売場所をカスタムマーカー（🔥アイコン）で表示
- 現在地の自動取得と表示
- マーカークリックでポップアップ表示（場所名、薪の種類、価格）
- 地図のズーム・移動操作

### 📝 薪販売場所の登録機能
- **場所名**: 販売所の名称
- **薪の種類**: ナラ、クヌギ、スギなど
- **価格**: 最低購入可能額 500円、2000円など
- **住所**: 販売場所の住所 （マップから座標を取得可能）
- **位置情報**: 緯度・経度（現在地取得ボタンで自動入力可能）
- **連絡先**: 電話番号やメールアドレス
- **備考**: 営業時間やその他の情報

### 🔍 検索・フィルター機能
- 薪の種類でフィルタリング
- キーワード検索（場所名、備考）
- フィルタークリア機能

### 📱 リスト表示機能
- 登録された販売場所の一覧表示
- カード形式の見やすいレイアウト
- リストパネルの開閉機能
- カードクリックで詳細表示

### 📖 詳細情報表示
- 各販売場所の詳細情報をモーダルで表示
- 地図で確認ボタンで該当場所にフォーカス

### ヘルプ表示機能
- マニュアルを表示する
- 図を用いた操作方法を参照

### 📱 PWA機能
- オフライン対応（Service Worker）
- ホーム画面への追加
- スタンドアロンモード
- アプリアイコン設定

### 🎨 レスポンシブデザイン
- PC、タブレット、スマートフォンに対応
- モバイルファーストデザイン
- タッチ操作最適化

## 🏗️ 技術スタック

### フロントエンド
- **HTML5**: セマンティックマークアップ
- **CSS3**: カスタムプロパティ、グリッドレイアウト、アニメーション
- **JavaScript (ES6+)**: Async/Await、Fetch API、DOM操作

### ライブラリ・API
- **[Leaflet.js 1.9.4](https://leafletjs.com/)**: オープンソース地図ライブラリ
- **[OpenStreetMap](https://www.openstreetmap.org/)**: 無料の地図タイル
- **[Font Awesome 6.4.0](https://fontawesome.com/)**: アイコンフォント
- **[Google Fonts - Noto Sans JP](https://fonts.google.com/)**: 日本語Webフォント

### バックエンド・データ管理
- **Supabase**: PostgreSQLタイプのクラウドDB
- **テーブル**: `firewood_locations`
- **完全無料**: 500MBまでサーバー費用不要

### PWA技術
- **Service Worker**: キャッシュ戦略とオフライン対応
- **Web App Manifest**: アプリメタデータとアイコン
- **Geolocation API**: 位置情報取得

## 📂 プロジェクト構造

```
/
├── index.html              # メインHTMLファイル
├── manifest.json           # PWAマニフェスト
├── service-worker.js       # Service Worker
├── src/
│   ├── constants.js        # 定数定義（Supabase設定、マップ設定等）
│   ├── utils.js            # ユーティリティ関数（UI操作、通知等）
│   ├── api.js              # API通信関数（Supabase、住所検索等）
│   ├── map.js              # 地図関連機能（Leaflet操作、マーカー表示等）
│   ├── main.js             # メインアプリケーションロジック
│   ├── style.css           # メインスタイルシート
│   └── main.backup.js      # リファクタリング前のバックアップ
├── package.json            # プロジェクト設定
├── vite.config.js          # Viteビルド設定
└── README.md               # プロジェクトドキュメント
```

### 📋 コードベース構成（リファクタリング済み）

アプリケーションは機能ごとにモジュール化されており、メンテナンス性が高く設計されています。

#### **constants.js** - 設定定数を集約
- Supabase接続情報（URL、API Key）
- マップ設定（初期位置、ズーム、クラスタリング設定）
- UI設定（トースト表示時間、ズームレベル等）
- カラーパレット、アイコン設定

**変更が必要なケース:**
- Supabase接続情報を変更する時
- マップの初期表示位置を変更する時
- 通報閾値を調整する時

#### **utils.js** - 汎用ユーティリティ関数
- UI通知機能（`showToast`, `showLoading`, `hideLoading`）
- モーダル操作（`openModal`, `closeModal`）
- フォーム操作（`resetForm`）
- ポップアップコンテンツ生成（`createPopupContent`）
- 座標グループ化（`groupLocationsByCoords`）

**変更が必要なケース:**
- トースト表示時間を変更する時
- ポップアップのレイアウトを変更する時
- 共通のUI操作を追加する時

#### **api.js** - API通信を集約
- Supabaseへのデータ操作
  - `fetchLocations()` - 場所データの取得
  - `fetchLocationById()` - 特定場所の取得
  - `addLocation()` - 新規場所の追加
  - `updateLocation()` - 場所の更新
  - `deleteLocation()` - 場所の削除
  - `incrementReportCount()` - 通報数の増加
- 住所検索API（Nominatim）
- お問い合わせ送信

**変更が必要なケース:**
- APIエンドポイントを変更する時
- 新しいAPIを追加する時
- データ取得のフィルター条件を追加する時

#### **map.js** - 地図機能を集約
- 地図の初期化（Leaflet.js）
- マーカー表示とクラスタリング
- 座標選択機能（マップクリック、既存ピンクリック対応）
- 現在地取得
- 地図の表示範囲管理

**エクスポートされる変数:**
- `map` - Leafletマップインスタンス
- `selectionState` - 座標選択モードの状態

**変更が必要なケース:**
- マーカーのデザインを変更する時
- クラスタリングの挙動を調整する時
- 地図の操作方法を変更する時

#### **main.js** - メインアプリロジック（リファクタリングで約30%削減）
- アプリケーションの初期化
- イベントリスナーの設定
- モーダル操作（登録、編集、詳細表示）
- フォーム処理（登録・編集・削除）
- フィルター機能
- 通報機能

**変更が必要なケース:**
- 新しい機能を追加する時
- フォームの検証ルールを変更する時
- イベント処理を追加する時

## 🗄️ データモデル

### firewood_locations テーブル

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| id | text | レコードID（自動生成） |
| location_name | text | 場所名（例：〇〇薪販売所） |
| wood_type | text | 薪の種類（例：ナラ、クヌギ、スギ） |
| price | number | 価格情報（例：500、2000） |
| latitude | number | 緯度 |
| longitude | number | 経度 |
| notes | text | 備考（営業時間、その他情報） |
| updated_at | timestamp | 最終更新日 |
| report_count | number | 通報回数 |

### システムフィールド（自動管理）
- `gs_project_id`: プロジェクト識別子
- `gs_table_name`: テーブル名
- `created_at`: 作成日時（ミリ秒）
- `updated_at`: 更新日時（ミリ秒）

## 🚀 使い方

### 1. 薪販売場所の登録
1. 右上の **「新規登録」** ボタンをクリック
2. 必須項目（場所名、薪の種類、価格、緯度・経度）を入力
3. **「現在地を取得」** ボタンで位置情報を自動入力（推奨）
4. その他の情報（住所、連絡先、備考）を入力
5. **「登録」** ボタンをクリック

### 2. 薪販売場所の検索
1. 左上の **「フィルター」** ボタンをクリック
2. 薪の種類やキーワードを入力
3. **「検索」** ボタンをクリック
4. 地図とリストに結果が表示されます

### 3. 詳細情報の確認
- 地図上のマーカーをクリック → ポップアップで基本情報表示
- リストのカードをクリック → 詳細情報モーダル表示
- 詳細モーダルの **「地図で確認」** ボタンで地図にフォーカス

### 4. 薪販売所の編集
1. 詳細モーダルから編集ボタンをクリック→編集モード
2. 必須項目（場所名、薪の種類、価格、緯度・経度）を入力
3. **「現在地を取得」** ボタンで位置情報を自動入力（推奨）
4. その他の情報（住所、連絡先、備考）を入力
5. **「登録」** ボタンをクリックでデータを更新

### 5. ヘルプ参照機能
- 操作マニュアルをヘルプボタンに搭載

### 6. PWAとして使用
1. スマートフォンのブラウザでアプリを開く
2. ブラウザメニューから **「ホーム画面に追加」** を選択
3. ホーム画面のアイコンからアプリを起動


## 🔌 API エンドポイント

### GET /tables/firewood_locations
全ての薪販売場所を取得

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）
- `limit`: 取得件数（デフォルト: 100）
- `search`: キーワード検索

**レスポンス:**
```json
{
  "data": [...],
  "total": 50,
  "page": 1,
  "limit": 100,
  "table": "firewood_locations",
  "schema": {...}
}
```

### GET /tables/firewood_locations/{id}
特定の薪販売場所を取得

**レスポンス:**
```json
{
  "id": "uuid",
  "location_name": "〇〇薪販売所",
  "wood_type": "ナラ、クヌギ",
  "price": "1束500円",
  ...
}
```

### POST /tables/firewood_locations
新しい薪販売場所を登録

**リクエストボディ:**
```json
{
  "location_name": "〇〇薪販売所",
  "wood_type": "ナラ、クヌギ",
  "price": "1束500円",
  "latitude": 35.681236,
  "longitude": 139.767125,
  "address": "東京都千代田区...",
  "contact": "090-1234-5678",
  "notes": "営業時間: 9:00-17:00"
}
```

## 💰 無料運用について

このアプリは完全無料で運用できます：

### 無料コンポーネント
- ✅ **OpenStreetMap**: 無料の地図タイル
- ✅ **Leaflet.js**: オープンソースの地図ライブラリ
- ✅ **RESTful Table API**: プラットフォーム提供の無料データベース
- ✅ **Font Awesome**: 無料版アイコン
- ✅ **Google Fonts**: 無料Webフォント
- ✅ **静的ホスティング**: サーバーレス構成

### 制限事項
- OpenStreetMapの利用規約に従う必要があります
- 大量アクセス時は独自タイルサーバーの検討が必要な場合があります
- RESTful Table APIの無料枠の制限（プラットフォームにより異なる）

## 🔮 今後の実装予定機能

### 優先度: 高
- [ ] 販売場所の編集・削除機能
- [ ] ユーザー認証（投稿者管理）
- [ ] 画像アップロード機能（薪の写真）
- [ ] 営業時間の構造化データ入力
- [ ] レビュー・評価機能

### 優先度: 中
- [ ] お気に入り機能
- [ ] 共有機能（SNS連携）
- [ ] ルート検索（現在地から販売場所へ）
- [ ] 在庫状況の表示
- [ ] 通知機能（新規登録時）

### 優先度: 低
- [ ] 多言語対応
- [ ] ダークモード
- [ ] データエクスポート機能
- [ ] 統計情報の表示
- [ ] 管理者ダッシュボード

## 🔧 開発ワークフロー

### 環境構築
```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動（ホットリロード対応）
npm run dev

# プロダクションビルド
npm run build

# ビルド結果のプレビュー
npm run preview
```

### メンテナンス方法

#### 新機能の追加
1. **定数が必要な場合** → `src/constants.js`に追加
2. **汎用的な関数** → `src/utils.js`に追加
3. **API通信** → `src/api.js`に追加
4. **地図関連** → `src/map.js`に追加
5. **アプリロジック** → `src/main.js`に追加

#### よくある変更例

**Supabaseの接続情報を変更:**
```javascript
// src/constants.js
export const CONFIG = {
    SUPABASE_URL: 'https://your-project.supabase.co',
    SUPABASE_ANON_KEY: 'your-anon-key',
    // ...
};
```

**マップの初期位置を変更:**
```javascript
// src/constants.js
export const CONFIG = {
    // ...
    DEFAULT_CENTER: [35.6812, 139.7671], // 東京
    DEFAULT_ZOOM: 10,
};
```

**トースト表示時間を変更:**
```javascript
// src/constants.js
export const UI_CONFIG = {
    TOAST_DURATION: 5000, // 5秒に変更
    // ...
};
```

**新しいフィルター条件を追加:**
```javascript
// src/api.js の fetchLocations()
if (filters.salesPeriod) {
    url += `&sales_period=ilike.*${encodeURIComponent(filters.salesPeriod)}*`;
}
```

### コーディング規約
1. **ES6モジュール** - `import`/`export`を使用
2. **関数にはJSDocコメント**を付ける
3. **定数は大文字**で定義（例: `CONFIG`, `MAP_CONFIG`）
4. **関数名は動詞から始める**（例: `fetchLocations`, `showToast`）
5. **非同期処理は`async/await`**を使用

### トラブルシューティング

**ビルドエラーが出る:**
- `npm install`で依存関係を再インストール
- 各ファイルのimport文が正しいか確認

**地図が表示されない:**
- `src/map.js`の`initMap()`が正しく呼ばれているか確認
- ブラウザのコンソールでエラーを確認

**データが取得できない:**
- `src/constants.js`のSupabase設定を確認
- ネットワークタブでAPIリクエストを確認
- Supabaseのダッシュボードで権限を確認

## 🛠️ 開発推奨事項

### 次のステップ
1. **ユーザー認証の実装**: 投稿の信頼性向上
2. **画像アップロード**: 薪の写真で情報を充実
3. **編集・削除機能**: データメンテナンス機能
4. **レビュー機能**: ユーザー体験の共有
5. **在庫状況**: リアルタイム在庫情報

### 技術的改善
- TypeScriptへの移行（型安全性向上）
- 状態管理ライブラリの導入（React/Vue.js等）
- ユニットテスト・E2Eテストの追加
- パフォーマンス最適化（画像遅延読み込み等）
- SEO対策（メタタグ、構造化データ）

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 貢献

バグ報告や機能リクエストは大歓迎です！プルリクエストもお待ちしています。

## 📞 サポート

問題が発生した場合は、GitHubのIssueセクションで報告してください。

---

**薪マップ** - キャンプと薪ストーブライフをもっと便利に 🔥🪵
